name: TICKET-MATE-BE-SCHEMA-VERIFY

on:
  pull_request:
    branches:
      - deploy
      - main
      - test

jobs:
  schema-verify:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë””ë ‰í„°ë¦¬ ì¤€ë¹„
        run: mkdir -p ticketmate-api/build/generated

      - name: JDK ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Gradle Wrapper ì‹¤í–‰ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Postgres ì¤€ë¹„ í™•ì¸ (ì»¨í…Œì´ë„ˆ í´ë¼ì´ì–¸íŠ¸)
        run: |
          for i in {1..30}; do
            if docker run --rm --network=host postgres:17-alpine \
              pg_isready -h localhost -p 5432 -U postgres; then
              echo "âœ… Postgres ì¤€ë¹„ ì™„ë£Œ"
              exit 0
            fi
            echo "â³ DB ì¤€ë¹„ ëŒ€ê¸°ì¤‘... ($i/30)"
            sleep 2
          done
          echo "âŒ Postgresê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." && exit 1

      - name: Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© (Docker)
        run: |
          docker run --rm --network=host \
            -v "$PWD/ticketmate-api/src/main/resources/db/migration":/flyway/sql \
            flyway/flyway:10 \
            -url=jdbc:postgresql://localhost:5432/postgres \
            -user=postgres -password=postgres \
            -baselineOnMigrate=true \
            -locations=filesystem:/flyway/sql \
            migrate

      - name: Flyway ê²°ê³¼ ìŠ¤í‚¤ë§ˆ ë¤í”„
        run: |
          mkdir -p ticketmate-api/build/generated
          docker run --rm --network=host -e PGPASSWORD=postgres postgres:17-alpine \
            pg_dump -s -h localhost -U postgres -d postgres \
            > ticketmate-api/build/generated/flyway-schema.sql
          echo "ğŸ“ Flyway ìŠ¤í‚¤ë§ˆ ë¼ì¸ ìˆ˜:" $(wc -l < ticketmate-api/build/generated/flyway-schema.sql)

      - name: Hibernate DDL ìƒì„± (ìŠ¤í”„ë§ ë¯¸ì‚¬ìš©)
        run: |
          ./gradlew :ticketmate-api:test \
            --tests "com.ticketmate.backend.api.application.schema.HibernateDdlGeneratorTest" \
            --info
          echo "ğŸ“ Hibernate DDL ë¼ì¸ ìˆ˜:" $(wc -l < ticketmate-api/build/generated/hibernate-ddl.sql)

      - name: ì •ê·œí™” & ë¹„êµ
        run: |
          python3 scripts/normalize_sql.py \
            ticketmate-api/build/generated/hibernate-ddl.sql \
            ticketmate-api/build/generated/flyway-schema.sql \
          && echo "âœ… ìŠ¤í‚¤ë§ˆ ì¼ì¹˜"
        shell: bash

      - name: ì°¨ì´ ì¶œë ¥(ë¶ˆì¼ì¹˜ ì‹œ)
        if: failure()
        run: |
          echo "âŒ ìŠ¤í‚¤ë§ˆê°€ ë‹¤ë¦…ë‹ˆë‹¤. ì •ê·œí™” ê²°ê³¼(diff) ì¶œë ¥:"
          diff -u \
            ticketmate-api/build/generated/hibernate-ddl.sql.norm \
            ticketmate-api/build/generated/flyway-schema.sql.norm || true

      - name: ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-compare-artifacts
          path: |
            ticketmate-api/build/generated/*.sql
            ticketmate-api/build/generated/*.norm
