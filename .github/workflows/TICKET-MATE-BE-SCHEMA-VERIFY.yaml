name: TICKET-MATE-BE-SCHEMA-VERIFY

on:
  pull_request:
    branches: [deploy, main, test]
    paths:
      - 'ticketmate-api/**'
      - 'scripts/sql/**'
      - '.github/workflows/TICKET-MATE-BE-SCHEMA-VERIFY.yml'

permissions:
  contents: read

concurrency:
  group: schema-verify-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  schema-verify:
    runs-on: ubuntu-latest

    env:
      WORK_DIR: ${{ github.workspace }}
      MODULE: ticketmate-api
      GEN_DIR: ${{ github.workspace }}/ticketmate-api/build/generated
      HIB_DDL: ${{ github.workspace }}/ticketmate-api/build/generated/hibernate-ddl.sql
      FLY_SCHEMA: ${{ github.workspace }}/ticketmate-api/build/generated/flyway-schema.sql
      NORMALIZE_PY: ${{ github.workspace }}/scripts/sql/normalize_sql.py
      DIFF_PY: ${{ github.workspace }}/scripts/sql/make_sql_diff_report.py
      COMPARE_SH: ${{ github.workspace }}/scripts/sql/schema_compare.sh
      MIG_DIR: ${{ github.workspace }}/ticketmate-api/src/main/resources/db/migration
      REQUIRE_MIGRATIONS: "false"

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„± (KST, í•­ìƒ ì‹¤í–‰)
        id: ts
        if: always()
        run: |
          TS=$(TZ=Asia/Seoul date '+%Y%m%d_%H%M%S')
          echo "ts=$TS" >> "$GITHUB_OUTPUT"   # steps.ts.outputs.ts ë¡œ ì‚¬ìš©
          echo "TS=$TS" >> "$GITHUB_ENV"
          echo "ğŸ“Œ Artifact timestamp(KST): $TS"

      # ğŸ” Flyway íŒŒì¼ëª… ê·œì¹™ ê²€ì‚¬ (VyyyyMMdd_HHmmss__xxx.sql)
      - name: Flyway íŒŒì¼ëª… ê·œì¹™ ê²€ì‚¬
        run: |
          if [ -d "$MIG_DIR" ]; then
            chmod +x "$WORK_DIR/scripts/sql/check_flyway_filenames.sh"
            "$WORK_DIR/scripts/sql/check_flyway_filenames.sh" "$MIG_DIR"
          else
            echo "â„¹ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ë””ë ‰í„°ë¦¬ê°€ ì—†ì–´ íŒŒì¼ëª… ê²€ì‚¬ë¥¼ ìƒëµí•©ë‹ˆë‹¤: $MIG_DIR"
          fi

      - name: ë””ë ‰í„°ë¦¬ ì¤€ë¹„
        run: mkdir -p "$GEN_DIR"

      - name: JDK ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Gradle Wrapper ì‹¤í–‰ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: ìŠ¤í¬ë¦½íŠ¸ ì¡´ì¬/ê¶Œí•œ í™•ì¸
        run: |
          echo "ğŸ“ scripts/sql ëª©ë¡:"
          ls -la "$WORK_DIR/scripts/sql" || true
          chmod +x "$COMPARE_SH" || true

      - name: Postgres ì¤€ë¹„ í™•ì¸ (ì»¨í…Œì´ë„ˆ í´ë¼ì´ì–¸íŠ¸)
        run: |
          for i in {1..30}; do
            if docker run --rm --network=host pgvector/pgvector:pg17 \
              pg_isready -h localhost -p 5432 -U postgres; then
              echo "âœ… Postgres ì¤€ë¹„ ì™„ë£Œ"
              exit 0
            fi
            echo "â³ DB ì¤€ë¹„ ëŒ€ê¸°ì¤‘... ($i/30)"
            sleep 2
          done
          echo "âŒ Postgresê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." && exit 1

      - name: ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ê°œìˆ˜ í™•ì¸ (ë””ë ‰í† ë¦¬ ìœ ë¬´ í¬í•¨)
        id: migcheck
        run: |
          if [ -d "$MIG_DIR" ]; then
            count=$(find "$MIG_DIR" -maxdepth 1 -type f -name '*.sql' | wc -l | xargs)
          else
            echo "â„¹ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ë””ë ‰í„°ë¦¬ê°€ ì—†ìœ¼ë¯€ë¡œ 0ê°œë¡œ ê°„ì£¼í•©ë‹ˆë‹¤: $MIG_DIR"
            count=0
          fi
          echo "MIG_COUNT=$count" >> $GITHUB_ENV
          echo "ğŸ” ë°œê²¬ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìˆ˜: $count"
          if [ "$count" != "0" ]; then
            echo "ğŸ“„ ëª©ë¡:"
            find "$MIG_DIR" -maxdepth 1 -type f -name '*.sql' -print | sort
          fi

      - name: Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© (Docker)
        if: env.MIG_COUNT != '0'
        run: |
          docker run --rm --network=host \
            -v "$WORK_DIR/${MODULE}/src/main/resources/db/migration":/flyway/sql \
            flyway/flyway:10 \
            -url=jdbc:postgresql://localhost:5432/postgres \
            -user=postgres -password=postgres \
            -locations=filesystem:/flyway/sql \
            migrate

      - name: Flyway ê²°ê³¼ ìŠ¤í‚¤ë§ˆ ë¤í”„
        if: env.MIG_COUNT != '0'
        run: |
          docker run --rm --network=host -e PGPASSWORD=postgres postgres:17-alpine \
            pg_dump -s -h localhost -U postgres -d postgres > "$FLY_SCHEMA"
          echo "ğŸ“ Flyway ìŠ¤í‚¤ë§ˆ ë¼ì¸ ìˆ˜:" $(wc -l < "$FLY_SCHEMA")

      - name: ë¹ˆ Flyway ìŠ¤í‚¤ë§ˆ íŒŒì¼ ìƒì„±(ë§ˆì´ê·¸ë ˆì´ì…˜ ì—†ìŒ)
        if: env.MIG_COUNT == '0'
        run: |
          echo "-- no user migrations" > "$FLY_SCHEMA"

      - name: Flyway DDL ìŠ¤ëƒ…ìƒ· í™•ì¸/ì¶œë ¥
        run: |
          if [ -f "$FLY_SCHEMA" ]; then
            echo "âœ… Flyway ìŠ¤í‚¤ë§ˆ ë¤í”„ ì¡´ì¬: $FLY_SCHEMA"
            echo "----- [ì²˜ìŒ 60ì¤„] -----"
            sed -n '1,60p' "$FLY_SCHEMA"
            echo "----- [ë§ˆì§€ë§‰ 30ì¤„] -----"
            tail -n 30 "$FLY_SCHEMA"
          else
            echo "âŒ Flyway ìŠ¤í‚¤ë§ˆ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $FLY_SCHEMA"
            echo "ğŸ“‚ í˜„ì¬ ìƒì„± ë””ë ‰í„°ë¦¬ ëª©ë¡:"
            ls -la "$GEN_DIR" || true
            exit 1
          fi

      - name: Hibernate DDL ìƒì„± (ìŠ¤í”„ë§ ë¯¸ì‚¬ìš©, í•´ë‹¹ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰)
        run: |
          ./gradlew :${MODULE}:test --tests '*HibernateDdlGeneratorTest' --info --no-build-cache
          echo "ğŸ“ Hibernate DDL ë¼ì¸ ìˆ˜:" $(wc -l < "$HIB_DDL")

      - name: Hibernate DDL ìŠ¤ëƒ…ìƒ· í™•ì¸/ì¶œë ¥ (ì¡´ì¬/ìš©ëŸ‰ ê²€ì¦)
        run: |
          if [ ! -f "$HIB_DDL" ]; then
            echo "âŒ Hibernate DDL íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $HIB_DDL"
            ls -la "$GEN_DIR" || true
            exit 1
          fi
          if [ ! -s "$HIB_DDL" ]; then
            echo "âŒ Hibernate DDL íŒŒì¼ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤: $HIB_DDL"
            exit 1
          fi
          echo "âœ… Hibernate DDL ì¡´ì¬ ë° ìœ íš¨: $HIB_DDL"
          echo "----- [ì²˜ìŒ 60ì¤„] -----"
          sed -n '1,60p' "$HIB_DDL"
          echo "----- [ë§ˆì§€ë§‰ 30ì¤„] -----"
          tail -n 30 "$HIB_DDL"

      - name: ì •ì±… ê²€ì‚¬ (ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìˆ˜ ì—¬ë¶€)
        if: env.MIG_COUNT == '0' && env.REQUIRE_MIGRATIONS == 'true'
        run: |
          echo "âŒ ì •ì±…ìƒ ìµœì†Œ 1ê°œì˜ Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ì´ í•„ìš”í•©ë‹ˆë‹¤. (REQUIRE_MIGRATIONS=true)"
          exit 1

      - name: ë§ˆì´ê·¸ë ˆì´ì…˜ ì—†ìŒ - ì •ê·œí™”ë§Œ ìˆ˜í–‰(ë¹„êµ ìƒëµ, ìš”ì•½ ë¦¬í¬íŠ¸ ìƒì„±)
        if: env.MIG_COUNT == '0'
        run: |
          echo "â„¹ï¸ ì‚¬ìš©ì ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ ì—†ì–´ ë¹„êµëŠ” ìƒëµí•©ë‹ˆë‹¤. ëŒ€ì‹  ì •ê·œí™” ë° ìš”ì•½ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."
          python3 "$NORMALIZE_PY" "$HIB_DDL" "$FLY_SCHEMA" || true
          python3 "$DIFF_PY" "$HIB_DDL.norm" "$FLY_SCHEMA.norm" "$GEN_DIR/schema-compare-summary.md" || true

      - name: ë¹„êµ ì…ë ¥ íŒŒì¼ í™•ì¸(ë””ë²„ê¹…)
        if: env.MIG_COUNT != '0'
        run: |
          echo "HIB_DDL=$HIB_DDL"
          echo "FLY_SCHEMA=$FLY_SCHEMA"
          ls -la "$GEN_DIR" || true
          test -f "$HIB_DDL"
          test -f "$FLY_SCHEMA"

      - name: ë¹„êµ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ì •ê·œí™” + ë¹„êµ + ë¦¬í¬íŠ¸)
        if: env.MIG_COUNT != '0'
        env:
          STRICT_ENUM_CHECK: "true"   # â† ê¸°ë³¸ì€ false
        run: |
          bash "$COMPARE_SH" "$HIB_DDL" "$FLY_SCHEMA" "$NORMALIZE_PY" "$DIFF_PY"
        shell: bash

      - name: ì‚°ì¶œë¬¼ ëª©ë¡(ì—…ë¡œë“œ ì§ì „)
        if: always()
        run: |
          echo "ğŸ“‚ $GEN_DIR ë‚´ìš©:"
          ls -la "$GEN_DIR" || true
          echo ""
          echo "ğŸ“ íŒŒì¼ í¬ê¸°:"
          du -ah "$GEN_DIR" || true

      - name: ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-compare-artifacts-${{ steps.ts.outputs.ts || github.run_id }}
          path: ${{ env.GEN_DIR }}
          if-no-files-found: error
          retention-days: 14
