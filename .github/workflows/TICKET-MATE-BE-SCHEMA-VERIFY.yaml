name: TICKET-MATE-BE-SCHEMA-VERIFY

on:
  pull_request:
    branches:
      - deploy
      - main
      - test

jobs:
  schema-verify:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Gradle Wrapper ì‹¤í–‰ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # JPA ì—”í‹°í‹°ë§Œìœ¼ë¡œ ê²½ëŸ‰ ìŠ¤í‚¤ë§ˆ ê²€ì¦ ì‹¤í–‰ (Spring Context ë¡œë“œ ì—†ìŒ)
      - name: JPA ì—”í‹°í‹° ê¸°ë°˜ ê²½ëŸ‰ ìŠ¤í‚¤ë§ˆ ê²€ì¦
        run: ./gradlew :ticketmate-api:clean :ticketmate-api:test --info --tests "com.ticketmate.api.schema.SchemaVerificationTest"

      # ìƒì„±ëœ DDL íŒŒì¼ë“¤ í™•ì¸ ë° ë¹„êµ ê²°ê³¼ ì¶œë ¥
      - name: DDL ê²€ì¦ ê²°ê³¼ í™•ì¸
        run: |
          echo "ğŸ” DDL ê²€ì¦ ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
          
          if [ -f ticketmate-api/build/generated/hibernate-ddl-direct.sql ]; then
            echo "âœ… Hibernate DDL íŒŒì¼ ìƒì„±ë¨:"
            wc -l ticketmate-api/build/generated/hibernate-ddl-direct.sql
            echo ""
            echo "=== Hibernate DDL ìƒ˜í”Œ (ì²˜ìŒ 5ì¤„) ==="
            head -5 ticketmate-api/build/generated/hibernate-ddl-direct.sql
          else
            echo "âŒ Hibernate DDL íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          fi
          
          echo ""
          if [ -f ticketmate-api/src/main/resources/db/migration/V1__Initial_schema.sql ]; then
            echo "âœ… Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì¡´ì¬:"
            wc -l ticketmate-api/src/main/resources/db/migration/V1__Initial_schema.sql
            echo ""
            echo "=== Flyway DDL ìƒ˜í”Œ (ì²˜ìŒ 5ì¤„) ==="
            head -5 ticketmate-api/src/main/resources/db/migration/V1__Initial_schema.sql
          else
            echo "âŒ Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
          fi

      # DDL íŒŒì¼ë“¤ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ (ë””ë²„ê¹…ìš©)
      - name: Schema artifacts ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: schema-verification-results
          path: |
            ticketmate-api/build/generated/hibernate-ddl-direct.sql
            ticketmate-api/src/main/resources/db/migration/*.sql
          if-no-files-found: warn
