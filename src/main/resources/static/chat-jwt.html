<!-- ************************************************************
   TicketMate â€“ 1 : 1 Chat í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ (Infiniteâ€‘Scrollv4.0, 2025â€‘06â€‘27)
   --------------------------------------------------------------
   * Slice ê¸°ë°˜ í˜ì´ì§•(ê¸°ë³¸ 20ê°œ) & ë¬´í•œ ìŠ¤í¬ë¡¤ â†‘ êµ¬í˜„
   * first / last í”Œë˜ê·¸ë¡œ ì´ì „ í˜ì´ì§€ ì¡´ì¬ ì—¬ë¶€ íŒë‹¨
   * ìµœì‹  ë©”ì‹œì§€ê°€ í•­ìƒ ë§¨ ì•„ë˜(ì˜¤ë˜ëœ â†’ ìµœì‹ )ë¡œ ë Œë”ë§
************************************************************* -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>TicketMate â€“ ì±„íŒ…ë°©1â€‘1(v4.0)</title>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

  <style>
    :root {
      --bubble-op: #e8f0ff;
      --bubble-me: #d1ffe5;
    }
    body { font-family: Arial,sans-serif; margin:2rem; }

    /* ====== ë°© ëª©ë¡ ====== */
    #roomList { max-width:22rem; border:1px solid #ccc; padding:1rem; }
    .room-item { padding:0.6rem 0; border-bottom:1px solid #eee; cursor:pointer; }
    .room-item:hover { background:#f3f7ff; }
    .room-top { display:flex; justify-content:space-between; align-items:center; }
    .room-name { font-weight:bold; }
    .time { font-size:0.72rem; color:#888; margin-left:0.5rem; }
    .badge { background:#ff3b30; color:#fff; border-radius:12px; padding:0 6px; font-size:0.7rem; min-width:1.4rem; text-align:center; }
    .preview { font-size:0.78rem; color:#555; margin-top:0.15rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* ğŸ“Œ ì˜ˆë§¤ íƒ€ì… í‘œì‹œ */
    .ticket-type { font-size:0.7rem; padding:0.2rem 0.5rem; border-radius:8px; font-weight:bold; margin-left:0.5rem; }
    .ticket-type.pre-open { background:#4CAF50; color:white; }
    .ticket-type.general-open { background:#2196F3; color:white; }
    .room-info { display:flex; align-items:center; margin-top:0.15rem; }

    /* ====== ì±„íŒ… + ì‹ ì²­ì„œ ====== */
    #chatContainer { display:flex; gap:1rem; max-width:60rem; }
    #chatSection { display:flex; flex-direction:column; gap:0.5rem; flex:1; }
    #chatBox { height:300px; overflow-y:auto; display:flex; flex-direction:column; border:1px solid #ccc; padding:1rem; }
    .msg { margin:0.25rem 0; padding:0.5rem 0.75rem; border-radius:1rem; max-width:70%; white-space:pre-wrap; }
    .sender-op { background:var(--bubble-op); align-self:flex-start; border-top-left-radius:0; }
    .sender-me { background:var(--bubble-me); align-self:flex-end; border-top-right-radius:0; }
    .meta { font-size:0.7rem; color:#555; margin-top:0.2rem; display:flex; align-items:center; gap:0.25rem; }
    .unread-dot { width:7px; height:7px; background:#ff3b30; border-radius:50%; display:inline-block; }
    .read-check { font-size:0.8rem; color:#888; }

    /* ğŸ“Œ ì‹ ì²­ì„œ íŒ¨ë„ */
    #formInfoSection { width:20rem; border:1px solid #ccc; padding:1rem; overflow-y:auto; display:none; }
    #formInfoSection h4 { margin:0.2rem 0 0.6rem; font-size:1rem; }
    .form-field { margin:0.25rem 0; font-size:0.85rem; }
    .detail-box { margin:0.5rem 0; padding:0.5rem; border:1px solid #eee; border-radius:0.5rem; }
    .detail-box h5 { margin:0.1rem 0 0.3rem; font-size:0.8rem; font-weight:bold; }
    .hope-list { margin:0.2rem 0 0 0.8rem; font-size:0.78rem; list-style:square; }
    /* ===== ğŸ”¶ v4.1 NEW â€“ Drag Hover íš¨ê³¼ ===== */
    #chatBox.drag-hover{ border:2px dashed #4caf50; background:#f6fff6; }

    #imgSelectButton {
      padding: 0.25rem 0.75rem;
      font-size: 0.85rem;
      background: #ffe0a3;
      border: 1px solid #ffb84d;
      border-radius: 0.5rem;
      cursor: pointer;
    }
    #imgSelectButton:hover {
      background: #ffd182;
    }


  </style>
</head>
<body>
<div id="loginSection">
  <button id="clientLoginButton">ì˜ë¢°ì¸ ë¡œê·¸ì¸</button>
  <button id="agentLoginButton">ëŒ€ë¦¬ì¸ ë¡œê·¸ì¸</button>
</div>

<div id="roomListSection" style="display:none">
  <h3>ì±„íŒ…ë°© ëª©ë¡</h3>
  <div id="roomList"></div>
</div>

<!-- ğŸ“Œ ì±„íŒ…+ì‹ ì²­ì„œ ì»¨í…Œì´ë„ˆ -->
<div id="chatContainer" style="display:none">
  <!-- ===== ì±„íŒ… ì˜ì—­ ===== -->
  <div id="chatSection">
    <input id="roomId" readonly />
    <div style="display:flex; gap:0.5rem">
      <input id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦" />

      <!-- ğŸ“· ì‚¬ì§„ ì„ íƒ ë²„íŠ¼ -->
      <button id="imgSelectButton" type="button" title="ì‚¬ì§„ ì„ íƒ">ì‚¬ì§„+</button>

      <!-- ì‹¤ì œ íŒŒì¼ ì„ íƒ input (ë©€í‹° ì—…ë¡œë“œ í—ˆìš©). display:none ìœ¼ë¡œ ìˆ¨ê¹€ -->
      <input
              id="imgInput"
              type="file"
              accept="image/*"
              multiple
              style="display:none"
      />

      <button id="sendButton">ì „ì†¡</button>
      <button id="toggleFormButton">ì‹ ì²­ì„œ ë³´ê¸°</button>
      <button id="logoutButton">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="chatBox"></div>
  </div>

  <!-- ğŸ“Œ ì‹ ì²­ì„œ ì •ë³´ íŒ¨ë„ -->
  <div id="formInfoSection">
    <h4>ì‹ ì²­ì„œ ì •ë³´</h4>
    <div id="formInfo">â€“</div>
  </div>
</div>
<script>
  /* ===============================================
   * CONFIG & CONSTANTS
   =============================================== */
  const API = "https://api.ticketmate.site";
  const BEARER = true;
  const TOKENS = {
    client: "eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiLssYTtjIXtgbTrnbxAbmF2ZXIuY29tMTQ0IiwiY2F0ZWdvcnkiOiJhY2Nlc3MiLCJ1c2VybmFtZSI6IuyxhO2Mhe2BtOudvEBuYXZlci5jb20xNDQiLCJtZW1iZXJJZCI6IjUzNjdjMGRkLTViNGYtNGJhNy04ZDc1LTQxZDM4YTFlOWM2ZCIsInJvbGUiOiJST0xFX1RFU1QiLCJpc3MiOiJUSUNLRVRfTUFURSIsImlhdCI6MTc1MzA4NDMwNSwiZXhwIjoxNzU1Njc2MzA1fQ.HLsrwYSAwQnFTSvZfaWTc_LlzaIlvjXt54FuaW8vyptrS0bYP8Y66-RvBs0BGfTE",
    agent: "eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiLssYTtjIXsl5DsnbRAbmF2ZXIuY29tNjAyIiwiY2F0ZWdvcnkiOiJhY2Nlc3MiLCJ1c2VybmFtZSI6IuyxhO2MheyXkOydtEBuYXZlci5jb202MDIiLCJtZW1iZXJJZCI6IjU5NDMwNGQ2LTdmNTUtNGQ0MS04YTI4LTQ0ODNhYTM0MzdjZiIsInJvbGUiOiJST0xFX1RFU1QiLCJpc3MiOiJUSUNLRVRfTUFURSIsImlhdCI6MTc1MzA4NDMyNywiZXhwIjoxNzU1Njc2MzI3fQ.yJAg8Aqr0yLbmZst74_ABV25kYL6dn2dqN19VC0OXCaEiqogtsciw5UCr4pGOger",
  };

  /* ===============================================
   * GLOBAL STATE
   =============================================== */
  let stomp = null;
  let myId = "";
  let formLoaded = false;
  const PAGE_SIZE = 20;  // Slice ê¸°ë³¸ í¬ê¸°

  let currentRoomId = null;      // ì ‘ì† ì¤‘ì¸ ì±„íŒ…ë°© ID
  let currentPage = 0;           // 0-base (DESC ì„œë²„ ì‘ë‹µì„ 1-baseë¡œ í˜¸ì¶œ)
  let lastPageReached = false;   // slice.last === true
  let loadingOlder = false;      // ì¤‘ë³µ ë¡œë”© ë°©ì§€

  /** STOMP ë°© êµ¬ë… í•¸ë“¤ ì €ì¥ */
  const roomSubscriptions = {};

  /** ì—…ë¡œë“œ tmp ë²„ë¸” ì¶”ì  í [{tmpId, count}] */
  const pendingUploads = [];

  /* ===== ğŸ”¶ v4.1 NEW â€“ ì‚¬ì§„ ì „ì†¡ ê³µí†µ ===== */
  const MAX_IMG_SIZE     = 10 * 1024 * 1024; // 10 MB
  const IMG_FIELD_SINGLE = "chatMessagePicture";    // ë ˆê±°ì‹œ
  const IMG_FIELD_MULTI  = "chatMessagePictureList"; // âœ… ë©€í‹° DTO í•„ë“œëª…

  function isImage(file){
    return file && file.type.startsWith("image/");
  }

  /* ===============================================
   * TOKEN / DATE UTILS
   =============================================== */
  const Token = {
    set: (t) => sessionStorage.setItem("at", t),
    get: () => sessionStorage.getItem("at"),
    clear: () => sessionStorage.removeItem("at"),
  };

  // JWT payload ì¶”ì¶œ
  const claims = () => {
    try {
      return JSON.parse(atob(Token.get().split(".")[1]));
    } catch {
      return {};
    }
  };

  // ë‚ ì§œ íŒŒì‹± (ê³µë°± â†’ T ë³´ì •)
  const parseDate = (s) => {
    if (!s || typeof s !== "string") return null;
    return new Date(s.includes("T") ? s : s.replace(" ", "T"));
  };

  const fmtTime = (d) =>
          d ? d.toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit" }) : "";

  const fmtDateTime = (d) =>
          d
                  ? d.toLocaleString("ko-KR", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                  })
                  : "";

  /* ===============================================
   * DTO ë§¤í•‘ í—¬í¼
   =============================================== */
  const mRoomId        = (o) => o.chatRoomId ?? o.roomId;
  const mUnread        = (o) => o.unReadMessageCount ?? o.unread;
  const mLastMsg       = (o) => o.lastMessage ?? o.lastChatMessage;
  const mLastSendTime  = (o) => o.sentAt ?? o.lastChatSendTime ?? o.sendDate;
  const mTicketOpenType= (o) => o.ticketOpenType;

  /* ===============================================
   * UI HELPERS
   =============================================== */
  const getTicketTypeInfo = (ticketOpenType) => {
    switch (ticketOpenType) {
      case "PRE_OPEN":     return { text: "ì„ ì˜ˆë§¤",   className: "pre-open" };
      case "GENERAL_OPEN": return { text: "ì¼ë°˜ì˜ˆë§¤", className: "general-open" };
      default:             return { text: "ë¯¸ì •",     className: "unknown" };
    }
  };

  function ensureItem(id, name, ticketOpenType) {
    let el = document.querySelector(`.room-item[data-room-id="${id}"]`);
    if (el) return el;

    const ticketTypeInfo = getTicketTypeInfo(ticketOpenType);
    el = document.createElement("div");
    el.className = "room-item";
    el.dataset.roomId = id;
    el.innerHTML = `
            <div class="room-top">
                <span class="room-name">${name}</span>
                <span class="time" data-room-id="${id}"></span>
                <span class="badge" data-room-id="${id}" style="visibility:hidden"></span>
            </div>
            <div class="room-info">
                <div class="preview" data-room-id="${id}"></div>
                <span class="ticket-type ${ticketTypeInfo.className}">${ticketTypeInfo.text}</span>
            </div>
        `;
    el.onclick = () => enterRoom(id);
    document.getElementById("roomList").appendChild(el);
    return el;
  }

  const upBadge = (id, n) => {
    const b = document.querySelector(`.badge[data-room-id="${id}"]`);
    if (b) {
      b.textContent = n || "";
      b.style.visibility = n ? "visible" : "hidden";
    }
  };
  const upPrev = (id, t) => {
    const p = document.querySelector(`.preview[data-room-id="${id}"]`);
    if (p) p.textContent = t || "";
  };
  const upTime = (id, s) => {
    const t = document.querySelector(`.time[data-room-id="${id}"]`);
    if (t) t.textContent = fmtTime(parseDate(s));
  };

  /* ===============================================
   * STOMP ì—°ê²° (í•­ìƒ ì¬ì—°ê²°)
   =============================================== */
  function connectStomp() {
    return new Promise((resolve) => {
      const doConnect = () => {
        stomp = Stomp.over(new SockJS(`${API}/chat`));
        stomp.connect(
                { Authorization: BEARER ? 'Bearer ' + Token.get() : Token.get() },
                () => {
                  ({ memberId: myId } = claims());
                  console.log('[STOMP CONNECTED] myId=', myId);
                  subscribeUnread();
                  resolve();
                },
                (err) => {
                  console.error('[STOMP ERROR]', err);
                  resolve();
                }
        );
      };

      if (stomp && stomp.connected) {
        try {
          stomp.disconnect(() => {
            console.log('[STOMP DISCONNECTED - RECONNECT]');
            doConnect();
          });
        } catch (e) {
          console.warn('[STOMP DISCONNECT FAILED]', e);
          doConnect();
        }
      } else {
        doConnect();
      }
    });
  }

  function subscribeUnread() {
    if (!stomp?.connected) return;
    stomp.subscribe(`/queue/unread.${myId}`, (msg) => {
      const dto = JSON.parse(msg.body);
      const id = mRoomId(dto);
      upBadge(id, mUnread(dto));
      upPrev(id, previewText(dto));
      upTime(id, mLastSendTime(dto));
    });
  }

  /**
   * ë°© WebSocket êµ¬ë…
   */
  function connectRoomWS(id) {
    return new Promise((resolve) => {
      const ready = () => {
        if (roomSubscriptions[id]) {
          try { roomSubscriptions[id].unsubscribe(); } catch {}
        }
        const sub = stomp.subscribe(
                `/exchange/chat.exchange/chat.room.${id}.user.${myId}`,
                (m) => onPacket(JSON.parse(m.body), id)
        );
        roomSubscriptions[id] = sub;
        resolve();
      };

      if (stomp?.connected) {
        ready();
      } else {
        connectStomp().then(ready);
      }
    });
  }

  /* ===============================================
   * ë°© ëª©ë¡ ë¡œë“œ
   =============================================== */
  async function loadRooms({ pageNumber = 1, ticketOpenType = '', searchKeyword = '' } = {}) {
    const qs = new URLSearchParams({ pageNumber });
    if (ticketOpenType) qs.append('ticketOpenType', ticketOpenType);
    if (searchKeyword)  qs.append('searchKeyword',  searchKeyword);

    const res = await fetch(
            `${API}/api/chat-room?` + qs.toString(),
            { headers: { Authorization: BEARER ? 'Bearer ' + Token.get() : Token.get() } }
    );
    const { content: rooms = [] } = await res.json();

    const listEl = document.getElementById('roomList');
    listEl.innerHTML = '';
    rooms.forEach(r => {
      const id   = mRoomId(r);
      const type = mTicketOpenType(r);

      ensureItem(id, r.chatRoomName, type);
      upBadge(id, mUnread(r));
      upPrev(id, previewText(r));
      upTime(id, mLastSendTime(r));
    });

    document.getElementById('roomListSection').style.display = 'block';
  }

  /* ===============================================
   * ë°© ì…ì¥
   =============================================== */
  async function enterRoom(id) {
    // UI í† ê¸€
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("roomListSection").style.display = "none";
    document.getElementById("chatContainer").style.display = "flex";

    document.getElementById("roomId").value = id;
    upBadge(id, 0);

    // ì‹ ì²­ì„œ íŒ¨ë„ ì´ˆê¸°í™”
    formLoaded = false;
    document.getElementById("formInfoSection").style.display = "none";
    document.getElementById("toggleFormButton").textContent = "ì‹ ì²­ì„œ ë³´ê¸°";

    // í˜ì´ì§• ìƒíƒœ ì´ˆê¸°í™”
    currentRoomId = id;
    currentPage = 0;
    lastPageReached = false;

    // ë°© êµ¬ë… ì¤€ë¹„ (STOMP ì—°ê²°ì´ ì—†ë‹¤ë©´ connectStompê°€ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬)
    await connectRoomWS(id);

    // Drag & Drop (ì¤‘ë³µ ë“±ë¡ ë°©ì§€ ìœ„í•´ ë¨¼ì € ì œê±° í›„ ë“±ë¡)
    const box = document.getElementById("chatBox");
    box.classList.remove("drag-hover");
    box.ondragenter = null; box.ondragover = null; box.ondragleave = null; box.ondrop = null;

    ["dragenter","dragover"].forEach(evt => box.addEventListener(evt,e=>{
      e.preventDefault();
      box.classList.add("drag-hover");
    }));
    ["dragleave","drop"].forEach(evt => box.addEventListener(evt,e=>{
      e.preventDefault();
      box.classList.remove("drag-hover");
    }));

    box.addEventListener("drop", async e => {
      const files = Array.from(e.dataTransfer.files || []);
      if (!files.length) return;
      const imgs = files.filter(isImage);
      if (!imgs.length) { alert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
      const overs = imgs.filter(f => f.size > MAX_IMG_SIZE);
      if (overs.length) { alert("ìµœëŒ€ 10MB ì´í•˜ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
      const ok = confirm(`${imgs.length}ì¥ ì‚¬ì§„ì„ ì „ì†¡í• ê¹Œìš”?`);
      if (!ok) return;
      await sendPictures(imgs, id);
    });

    // ìµœì‹  Slice ë¡œë“œ
    await loadSlice(id, currentPage, true);
  }

  /* ===============================================
   * Slice ë¡œë“œ
   * - ì„œë²„ëŠ” DESC(ìµœì‹ â†’ì˜¤ë˜ëœ) ê°€ì • â†’ reverse() í•˜ì—¬ ì˜¤ë˜ëœâ†’ìµœì‹ ìœ¼ë¡œ ë Œë”
   =============================================== */
  async function loadSlice(roomId, page, initialLoad = false) {
    if (loadingOlder) return;
    loadingOlder = true;

    const url = `${API}/api/chat-room/${roomId}?pageNumber=${page + 1}&pageSize=${PAGE_SIZE}`;
    const res = await fetch(url, {
      headers: { Authorization: BEARER ? "Bearer " + Token.get() : Token.get() },
    });
    if (!res.ok) { loadingOlder = false; return; }

    const slice = await res.json();
    const list = slice.content || [];
    list.reverse(); // ì˜¤ë˜ëœâ†’ìµœì‹ 

    const box = document.getElementById("chatBox");
    if (initialLoad) box.innerHTML = "";

    const prevHeight = box.scrollHeight;

    list.forEach((p) => {
      const isMine = p.mine;
      const isRead = p.read ?? p.isRead ?? (initialLoad ? true : !p.mine);
      displayMsg(p, isMine, isRead, !initialLoad /*prepend?*/);
    });

    if (initialLoad) {
      box.scrollTop = box.scrollHeight;
    } else {
      box.scrollTop = box.scrollHeight - prevHeight;
    }

    if (!slice.last) {
      currentPage += 1;
    } else {
      lastPageReached = true;
    }

    loadingOlder = false;
  }

  /* ===============================================
   * ì‹ ì²­ì„œ ì •ë³´
   =============================================== */
  async function loadApplicationForm(roomId) {
    try {
      const res = await fetch(`${API}/api/chat-room/${roomId}/application-form`, {
        headers: { Authorization: BEARER ? "Bearer " + Token.get() : Token.get() },
      });
      if (!res.ok) throw new Error(res.status);
      const info = await res.json();
      renderApplicationForm(info);
    } catch (e) {
      document.getElementById("formInfo").innerHTML =
              '<span style="color:red">ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</span>';
    }
  }

  function renderApplicationForm(info) {
    const box = document.getElementById("formInfo");
    box.innerHTML = `
            <div class="form-field"><b>ìƒíƒœ:</b> ${info.applicationFormStatus}</div>
            <div class="form-field"><b>ì˜ˆë§¤ êµ¬ë¶„:</b> ${info.ticketOpenType}</div>
            <div class="form-field"><b>ì˜ˆë§¤ì¼:</b> ${fmtDateTime(parseDate(info.openDate))}</div>
            ${info.applicationFormDetailResponseList
            .map(
                    (d, i) => `
                    <div class="detail-box">
                        <h5>ì„¸ë¶€ì‚¬í•­ #${i + 1}</h5>
                        <div><b>ê³µì—° ì¼ì‹œ:</b> ${fmtDateTime(parseDate(d.performanceDate))}</div>
                        <div><b>íšŒì°¨:</b> ${d.session}</div>
                        <div><b>ìš”ì²­ ë§¤ìˆ˜:</b> ${d.requestCount}</div>
                        ${d.hopeAreaResponseList?.length
                            ? `
                                <div><b>í¬ë§ êµ¬ì—­:</b></div>
                                <ul class="hope-list">
                                    ${d.hopeAreaResponseList
                                    .map(
                                            (h) => `
                                                <li>
                                                    (${h.priority}) ${h.location} â€“ â‚©${h.price.toLocaleString()}
                                                </li>`
                                    )
                                    .join("")}
                                </ul>`
                            : ""}
                        ${d.requirement ? `<div><i>${d.requirement}</i></div>` : ""}
                    </div>`
            )
            .join("")}
        `;
  }

  /* ===============================================
   * ë©”ì‹œì§€ ë Œë”ë§
   * - prepend=trueë©´ ìƒë‹¨ì— ì‚½ì…(ê³¼ê±° ë©”ì‹œì§€)
   =============================================== */
  function displayMsg(p, isMine, isRead, prepend = false) {
    const box = document.getElementById("chatBox");
    const div = document.createElement("div");

    div.className = `msg ${isMine ? "sender-me" : "sender-op"}`;
    div.dataset.msgId = p.messageId;

    // ì½˜í…ì¸ 
    if (p.chatMessageType === "PICTURE") {
      const pics = p.pictureMessageList || [];
      const count = pics.length || p._tmpCount || 0;

      if (count <= 1) {
        const url = pics[0] || p.message;
        const img = document.createElement("img");
        img.src = url;
        img.style.maxWidth = "160px";
        img.style.borderRadius = "0.5rem";
        img.style.cursor = "pointer";
        img.onclick = () => window.open(url, "_blank");
        div.appendChild(img);
      } else {
        const grid = document.createElement("div");
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = "repeat(2, minmax(0, 1fr))";
        grid.style.gap = "4px";
        grid.style.maxWidth = "160px";
        grid.style.position = "relative";

        const limited = pics.slice(0, 4);
        limited.forEach((url, idx) => {
          const img = document.createElement("img");
          img.src = url;
          img.style.width = "100%";
          img.style.height = "100%";
          img.style.objectFit = "cover";
          img.style.borderRadius = "0.25rem";
          img.style.cursor = "pointer";
          img.onclick = () => window.open(url, "_blank");
          grid.appendChild(img);

          if (idx === 3 && count > 4) {
            const overlay = document.createElement("div");
            overlay.textContent = `+${count - 4}`;
            overlay.style.position = "absolute";
            overlay.style.inset = "0";
            overlay.style.display = "flex";
            overlay.style.alignItems = "center";
            overlay.style.justifyContent = "center";
            overlay.style.fontWeight = "bold";
            overlay.style.fontSize = "1.1rem";
            overlay.style.color = "#fff";
            overlay.style.background = "rgba(0,0,0,0.55)";
            grid.appendChild(overlay);
          }
        });
        div.appendChild(grid);
      }
    } else {
      const spanNick = document.createElement("b");
      spanNick.textContent = p.senderNickname + ": ";
      const spanMsg = document.createElement("span");
      spanMsg.textContent = p.message;
      div.appendChild(spanNick);
      div.appendChild(spanMsg);
    }

    // ë©”íƒ€
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = fmtTime(parseDate(p.sendDate));
    if (isMine) {
      meta.innerHTML += isRead
              ? '<span class="read-check">âœ“</span>'
              : '<span class="unread-dot"></span>';
    }
    div.appendChild(meta);

    if (prepend) {
      box.prepend(div);
    } else {
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;  // ìƒˆ ë©”ì‹œì§€ ë„ì°© ì‹œ ì•„ë˜ë¡œ
    }
  }

  function scheduleTmpCleanup(tmpId) {
    setTimeout(() => {
      // ì„œë²„ ë©”ì‹œì§€ê°€ ì´ë¯¸ í™”ë©´ì— ìˆê³  tmpëŠ” ì•„ì§ ë‚¨ì•„ìˆë‹¤ë©´ ì œê±°
      const el = document.querySelector(`.msg.sender-me[data-msg-id="${tmpId}"]`);
      if (!el) return;
      // í™”ë©´ì— ë™ì¼í•œ ì‹œê°„ëŒ€(Â±5ì´ˆ) PICTURE mine ë©”ì‹œì§€ê°€ ìˆë‹¤ë©´ tmp ì‚­ì œ
      const lastMinePicture = Array.from(document.querySelectorAll('.msg.sender-me'))
              .reverse()
              .find(e => !e.dataset.msgId.startsWith('tmp-'));
      if (lastMinePicture) {
        el.remove();
        console.log('[TMP CLEANUP] removed stale tmp', tmpId);
      }
    }, 3000);
  }

  /* ===============================================
   * ì‹¤ì‹œê°„ íŒ¨í‚· ì²˜ë¦¬
   =============================================== */
  /* ==== onPacket (mine ì™„í™” & tmp ì œê±°) ==== */
  function onPacket(p, roomId) {
    console.log('[WS]', roomId, p);

    // ACK
    if (p.type === "READ_ACK") {
      if (p.readerId !== myId) {
        markReadAll(p.lastReadMessageId);
      }
      return;
    }

    const isFromMe = p.mine || (p.senderId && p.senderId === myId) || pendingUploads.length > 0;

    if (p.chatMessageType === "PICTURE" && isFromMe) {
      // ê°€ì¥ ì˜¤ë˜ëœ tmp ì œê±°
      const pending = pendingUploads.shift();
      if (pending) {
        const tmp = document.querySelector(`.msg.sender-me[data-msg-id="${pending.tmpId}"]`);
        if (tmp) tmp.remove();
        console.log('[TMP MATCHED]', pending?.tmpId, '->', p.messageId);
      } else {
        // í´ë°±
        document.querySelectorAll('.msg.sender-me[data-msg-id^="tmp-"]').forEach(el => el.remove());
        console.warn('[NO PENDING TMP] removed all tmp bubbles');
      }
      displayMsg(p, true, false);
    } else {
      displayMsg(p, p.mine, !p.mine);
    }

    upPrev(roomId, previewText(p));
    upTime(roomId, p.sendDate);
  }

  /* ===============================================
   * ì½ìŒ ì²˜ë¦¬
   =============================================== */
  function markReadAll(upto) {
    const msgs = document.querySelectorAll(".msg.sender-me");
    let found = false;
    for (const m of msgs) {
      m.querySelector(".unread-dot")?.remove();
      if (!m.querySelector(".read-check")) {
        m.querySelector(".meta").innerHTML += '<span class="read-check">âœ“</span>';
      }
      if (m.dataset.msgId === upto) found = true;
    }
    if (!found) {
      console.warn('[READ_ACK] upto id not found in DOM:', upto);
    }
  }

  function sendAckVisible() {
    const msgs = Array.from(document.querySelectorAll("#chatBox .msg"))
            .filter(m => !m.dataset.msgId?.startsWith("tmp-"));
    if (!msgs.length) return;
    const last = msgs[msgs.length - 1];
    const lastId = last.dataset.msgId;
    if (!lastId) {
      console.warn('[ACK] last message has no id');
      return;
    }
    stomp.send(
            `/pub/chat.read.${currentRoomId}`,
            {},
            JSON.stringify({
              lastReadMessageId: lastId,
              readDate: dayjs().format("YYYY-MM-DDTHH:mm:ss")
            })
    );
  }

  /* ===============================================
   * ë©”ì‹œì§€ ì „ì†¡ (TEXT)
   =============================================== */
  function sendMsg() {
    const txt = document.getElementById("message").value.trim();
    if (!txt) return;
    stomp.send(
            `/pub/chat.message.${document.getElementById("roomId").value}`,
            {},
            JSON.stringify({ message: txt })
    );
    document.getElementById("message").value = "";
  }

  /* ===============================================
   * ì‚¬ì§„ ì—…ë¡œë“œ (ë©€í‹°)
   =============================================== */
  async function sendPictures(files, roomId) {
    if (!files?.length) return;

    // 1) ì—…ë¡œë“œ ì‹œì‘ ì „ì— ì¦‰ì‹œ tmp í”„ë¦¬ë·° ìƒì„± (awaitëŠ” thumb ì¸ì½”ë”©ì„ ìœ„í•´ì„œ; ë” ë¹ ë¥´ê²Œ í•˜ë ¤ë©´ see ì•„ë˜)
    const tmpId = await displayTmpPictureBundle(files);  // âœ… ë¨¼ì €!

    const fd = new FormData();
    files.forEach(f => fd.append(IMG_FIELD_MULTI, f));

    try {
      const res = await fetch(
              `${API}/api/chat-message/${roomId}/send/pictures`,
              {
                method: "POST",
                headers: { Authorization: BEARER ? "Bearer " + Token.get() : Token.get() },
                body: fd
              }
      );
      if (!res.ok) throw new Error(res.status);
      // ì„±ê³µ ì‹œ: ì„œë²„ WebSocketì´ ë„ì°©í•˜ë©´ onPacket()ì—ì„œ tmp ì œê±°ë¨.
    } catch (e) {
      markTmpFailed(tmpId, e);  // ì—…ë¡œë“œ ì‹¤íŒ¨ UX (ì„ íƒ)
      alert("ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨: " + e);
    }
  }


  // ë ˆê±°ì‹œ ë‹¨ì¼ API ëŒ€ì‘
  async function sendPicture(file, roomId) {
    return sendPictures([file], roomId);
  }

  /* ===============================================
   * tmp í”„ë¦¬ë·° ë²„ë¸” ìƒì„±
   =============================================== */
  /* ==== displayTmpPictureBundle ==== */
  async function displayTmpPictureBundle(files) {
    const first = files[0];
    const thumb = await blobToDataURL(first);

    const tmpId = "tmp-" + crypto.randomUUID();
    pendingUploads.push({ tmpId, count: files.length, createdAt: Date.now() });

    const dto = {
      messageId: tmpId,
      senderNickname: claims().username ?? "ë‚˜",
      chatMessageType: "PICTURE",
      message: thumb,
      pictureMessageList: [thumb],
      sendDate: new Date().toISOString(),
      mine: true,
      _tmpCount: files.length
    };

    displayMsg(dto, true, false);
    console.log('[TMP CREATED]', tmpId, 'count=', files.length);

    scheduleTmpCleanup(tmpId); // ì„ íƒ
    return tmpId;
  }

  /* ===============================================
   * ë¯¸ë¦¬ë³´ê¸° í…ìŠ¤íŠ¸
   =============================================== */
  function previewText(dto) {
    if (dto.chatMessageType === "PICTURE") {
      const cnt = dto.pictureMessageList?.length ?? dto._tmpCount ?? 0;
      return cnt <= 1 ? "ì‚¬ì§„" : `ì‚¬ì§„ ${cnt}ì¥`;
    }
    return dto.message ?? mLastMsg(dto);
  }

  function blobToDataURL(blob){
    return new Promise(r=>{
      const reader=new FileReader();
      reader.onload=()=>r(reader.result);
      reader.readAsDataURL(blob);
    });
  }

  /* ===============================================
   * ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ (ì „ì—­ 1íšŒ ë“±ë¡)
   =============================================== */
  function attachScrollEvents() {
    const box = document.getElementById("chatBox");
    box.addEventListener("scroll", async () => {
      if (box.scrollTop === 0 && !lastPageReached && !loadingOlder) {
        await loadSlice(currentRoomId, currentPage);
      }
      if (box.scrollTop + box.clientHeight >= box.scrollHeight - 5) {
        sendAckVisible();
      }
    });
  }

  /* ===============================================
   * ì´ˆê¸°í™”
   =============================================== */
  window.addEventListener("DOMContentLoaded", () => {
    // ë¡œê·¸ì¸ ë²„íŠ¼
    document.getElementById('clientLoginButton').onclick = async () => {
      Token.set(TOKENS.client);
      await connectStomp();
      await loadRooms();
    };

    document.getElementById('agentLoginButton').onclick = async () => {
      Token.set(TOKENS.agent);
      await connectStomp();
      await loadRooms();
    };

    // ì‚¬ì§„ ì„ íƒ ë²„íŠ¼
    document.getElementById("imgSelectButton").onclick = () => {
      if (!currentRoomId) {
        alert("ì±„íŒ…ë°©ì— ë¨¼ì € ì…ì¥í•˜ì„¸ìš”.");
        return;
      }
      document.getElementById("imgInput").click();
    };

    // ì „ì†¡/ë¡œê·¸ì•„ì›ƒ/ì‹ ì²­ì„œ
    document.getElementById("sendButton").onclick = sendMsg;
    document.getElementById("logoutButton").onclick = () => {
      Object.values(roomSubscriptions).forEach(sub => {
        try { sub.unsubscribe(); } catch {}
      });
      try { stomp?.disconnect(); } catch {}
      Token.clear();
      location.reload();
    };
    document.getElementById("toggleFormButton").onclick = async () => {
      const panel = document.getElementById("formInfoSection");
      const btn = document.getElementById("toggleFormButton");
      if (panel.style.display === "none" || panel.style.display === "") {
        if (!formLoaded) { await loadApplicationForm(currentRoomId); formLoaded = true; }
        panel.style.display = "block"; btn.textContent = "ì‹ ì²­ì„œ ìˆ¨ê¸°ê¸°";
      } else {
        panel.style.display = "none"; btn.textContent = "ì‹ ì²­ì„œ ë³´ê¸°";
      }
    };

    // Enter í‚¤ ì „ì†¡
    document.getElementById("message").addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMsg();
    });

    // íŒŒì¼ input ë³€ê²½
    document.getElementById("imgInput").addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      if (!currentRoomId) { alert("ì±„íŒ…ë°©ì— ë¨¼ì € ì…ì¥í•˜ì„¸ìš”."); return; }

      const imgs = files.filter(isImage);
      if (!imgs.length) {
        alert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        e.target.value = "";
        return;
      }
      const overs = imgs.filter(f => f.size > MAX_IMG_SIZE);
      if (overs.length) {
        alert("ìµœëŒ€ 10MB ì´í•˜ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        e.target.value = "";
        return;
      }
      const ok = confirm(`${imgs.length}ì¥ ì‚¬ì§„ì„ ì „ì†¡í• ê¹Œìš”?`);
      if (!ok) { e.target.value = ""; return; }

      await sendPictures(imgs, currentRoomId);
      e.target.value = ""; // ë™ì¼ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ ì´ˆê¸°í™”
    });

    // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì „ì—­ ë“±ë¡
    attachScrollEvents();
  });
</script>

</body>
</html>