<!-- ************************************************************
   TicketMate â€“ 1 : 1 Chat í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ (Refactored v3.3, 2025â€‘06â€‘23)
   --------------------------------------------------------------
   * ì‹ ì²­ì„œ íŒ¨ë„ í•œêµ­ì–´ ë¼ë²¨ & í† ê¸€ ë²„íŠ¼ í•œêµ­ì–´í™” ì™„ë£Œ
   * renderApplicationForm() í•œêµ­ì–´ í•„ë“œ ë¼ë²¨ ì ìš©
   * ì½”ë“œ ì „ì²´ ë“¤ì—¬ì“°ê¸° ì •ë¦¬
************************************************************* -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>TicketMate â€“ ì±„íŒ…ë°© 1â€‘1 (v3.3)</title>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

  <style>
    :root {
      --bubble-op: #e8f0ff;
      --bubble-me: #d1ffe5;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
    }

    /* ====== ë°© ëª©ë¡ ====== */
    #roomList {
      max-width: 22rem;
      border: 1px solid #ccc;
      padding: 1rem;
    }
    .room-item {
      padding: 0.6rem 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .room-item:hover {
      background: #f3f7ff;
    }
    .room-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .room-name {
      font-weight: bold;
    }
    .time {
      font-size: 0.72rem;
      color: #888;
      margin-left: 0.5rem;
    }
    .badge {
      background: #ff3b30;
      color: #fff;
      border-radius: 12px;
      padding: 0 6px;
      font-size: 0.7rem;
      min-width: 1.4rem;
      text-align: center;
    }
    .preview {
      font-size: 0.78rem;
      color: #555;
      margin-top: 0.15rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ====== ì±„íŒ… + ì‹ ì²­ì„œ ====== */
    #chatContainer {
      display: flex;
      gap: 1rem;
      max-width: 60rem;
    }
    #chatSection {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
    }
    #chatBox {
      height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      padding: 1rem;
    }
    .msg {
      margin: 0.25rem 0;
      padding: 0.5rem 0.75rem;
      border-radius: 1rem;
      max-width: 70%;
      white-space: pre-wrap;
    }
    .sender-op {
      background: var(--bubble-op);
      align-self: flex-start;
      border-top-left-radius: 0;
    }
    .sender-me {
      background: var(--bubble-me);
      align-self: flex-end;
      border-top-right-radius: 0;
    }
    .meta {
      font-size: 0.7rem;
      color: #555;
      margin-top: 0.2rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .unread-dot {
      width: 7px;
      height: 7px;
      background: #ff3b30;
      border-radius: 50%;
      display: inline-block;
    }
    .read-check {
      font-size: 0.8rem;
      color: #888;
    }

    /* ğŸ“Œ ì‹ ì²­ì„œ íŒ¨ë„ */
    #formInfoSection {
      width: 20rem;
      border: 1px solid #ccc;
      padding: 1rem;
      overflow-y: auto;
      display: none;
    }
    #formInfoSection h4 {
      margin: 0.2rem 0 0.6rem;
      font-size: 1rem;
    }
    .form-field {
      margin: 0.25rem 0;
      font-size: 0.85rem;
    }
    .detail-box {
      margin: 0.5rem 0;
      padding: 0.5rem;
      border: 1px solid #eee;
      border-radius: 0.5rem;
    }
    .detail-box h5 {
      margin: 0.1rem 0 0.3rem;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .hope-list {
      margin: 0.2rem 0 0 0.8rem;
      font-size: 0.78rem;
      list-style: square;
    }
  </style>
</head>
<body>
<div id="loginSection">
  <button id="clientLoginButton">ì˜ë¢°ì¸ ë¡œê·¸ì¸</button>
  <button id="agentLoginButton">ëŒ€ë¦¬ì¸ ë¡œê·¸ì¸</button>
</div>

<div id="roomListSection" style="display: none">
  <h3>ì±„íŒ…ë°© ëª©ë¡</h3>
  <div id="roomList"></div>
</div>

<!-- ğŸ“Œ ì±„íŒ…+ì‹ ì²­ì„œ ì»¨í…Œì´ë„ˆ -->
<div id="chatContainer" style="display: none">
  <!-- ===== ì±„íŒ… ì˜ì—­ ===== -->
  <div id="chatSection">
    <input id="roomId" readonly />
    <div style="display: flex; gap: 0.5rem">
      <input id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦" />
      <button id="sendButton">ì „ì†¡</button>
      <button id="toggleFormButton">ì‹ ì²­ì„œ ë³´ê¸°</button>
      <button id="logoutButton">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div id="chatBox"></div>
  </div>

  <!-- ğŸ“Œ ì‹ ì²­ì„œ ì •ë³´ íŒ¨ë„ -->
  <div id="formInfoSection">
    <h4>ì‹ ì²­ì„œ ì •ë³´</h4>
    <div id="formInfo">â€“</div>
  </div>
</div>

<script>
  /* CONFIG */
  const API = "http://localhost:8080";
  const BEARER = true;
  const TOKENS = {
    client: "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJleGFtcGxlQG5hdmVyLmNvbSIsImNhdGVnb3J5IjoiYWNjZXNzIiwidXNlcm5hbWUiOiJleGFtcGxlQG5hdmVyLmNvbSIsIm1lbWJlcklkIjoiNmUzYTQxMWUtMmNjNS00NmVmLTliY2QtY2U0MDFkYmVkMzY1Iiwicm9sZSI6IlJPTEVfVEVTVCIsImlzcyI6IlRJQ0tFVF9NQVRFIiwiaWF0IjoxNzQ5NDY0MzgyLCJleHAiOjIxMDk0NjQzODJ9.gpUzai0TlvPDkpXS_JKYElOIfOrzeVBT8gC5LGFYLO7X0WzG3H6S1HYJazonv9vxt7EgEiZe1MdK_Oo3HmRr4A",
    agent: "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJleGExMjNtcGxlQG5hdmVyLmNvbSIsImNhdGVnb3J5IjoiYWNjZXNzIiwidXNlcm5hbWUiOiJleGExMjNtcGxlQG5hdmVyLmNvbSIsIm1lbWJlcklkIjoiMTc1MzBlMmMtMzI4MC00MmQ4LWI0MTgtOGM2ZTI3ZTdlNzZiIiwicm9sZSI6IlJPTEVfVEVTVCIsImlzcyI6IlRJQ0tFVF9NQVRFIiwiaWF0IjoxNzQ5NDY0NDA3LCJleHAiOjIxMDk0NjQ0MDd9.GTLFf7MVIgQ1M6d2VHKRUw8W86lLERZy9MBdEA4L8SrHTCClEuzHXgbBKjOJvtsaXRf2ZNT2QxzK_2S0ivUnRA",
  };

  /* ìƒíƒœ */
  let stomp = null;
  let myId = "";
  let formLoaded = false; // ğŸ“Œ ì‹ ì²­ì„œ ìºì‹œ ìƒíƒœ

  const Token = {
    set: (t) => sessionStorage.setItem("at", t),
    get: () => sessionStorage.getItem("at"),
    clear: () => sessionStorage.removeItem("at"),
  };
  const claims = () => {
    try {
      return JSON.parse(atob(Token.get().split(".")[1]));
    } catch {
      return {};
    }
  };

  /* ë‚ ì§œ í—¬í¼ */
  const parseDate = (s) => {
    if (!s || typeof s !== "string") return null;
    return new Date(s.includes("T") ? s : s.replace(" ", "T"));
  };
  const fmtTime = (d) =>
          d ? d.toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit" }) : "";
  const fmtDateTime = (d) =>
          d
                  ? d.toLocaleString("ko-KR", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                  })
                  : "";

  /* DTO â†”ï¸ í”„ë¡ íŠ¸ ë§¤í•‘ */
  const mRoomId = (o) => o.roomId ?? o.chatRoomId;
  const mUnread = (o) => o.unread ?? o.unReadMessageCount;
  const mLastMsg = (o) => o.lastMessage ?? o.lastChatMessage;
  const mLastSendTime = (o) => o.sentAt ?? o.lastChatSendTime;

  /* ---------- DOM í—¬í¼ ---------- */
  function ensureItem(id, name) {
    let el = document.querySelector(`.room-item[data-room-id="${id}"]`);
    if (el) return el;
    el = document.createElement("div");
    el.className = "room-item";
    el.dataset.roomId = id;
    el.innerHTML = `
          <div class="room-top">
            <span class="room-name">${name}</span>
            <span class="time" data-room-id="${id}"></span>
            <span class="badge" data-room-id="${id}" style="visibility:hidden"></span>
          </div>
          <div class="preview" data-room-id="${id}"></div>
        `;
    el.onclick = () => enterRoom(id);
    document.getElementById("roomList").appendChild(el);
    return el;
  }
  const upBadge = (id, n) => {
    const b = document.querySelector(`.badge[data-room-id="${id}"]`);
    if (b) {
      b.textContent = n || "";
      b.style.visibility = n ? "visible" : "hidden";
    }
  };
  const upPrev = (id, t) => {
    const p = document.querySelector(`.preview[data-room-id="${id}"]`);
    if (p) p.textContent = t || "";
  };
  const upTime = (id, s) => {
    const t = document.querySelector(`.time[data-room-id="${id}"]`);
    if (t) t.textContent = fmtTime(parseDate(s));
  };

  /* ---------- 1) ë°© ëª©ë¡ ---------- */
  async function loadRooms() {
    const res = await fetch(
            `${API}/api/chat-room/list?isPreOpen=ALL&pageNum=0`,
            { headers: { Authorization: BEARER ? "Bearer " + Token.get() : Token.get() } }
    );
    const rooms = (await res.json()).content || [];
    document.getElementById("roomList").innerHTML = "";
    rooms.forEach((r) => {
      const id = mRoomId(r);
      ensureItem(id, r.chatRoomName);
      upBadge(id, mUnread(r));
      upPrev(id, mLastMsg(r));
      upTime(id, mLastSendTime(r));
    });
    document.getElementById("roomListSection").style.display = "block";
  }

  /* ---------- 2) ë¯¸ì½ìŒ WebSocket ---------- */
  function connectUnread() {
    if (stomp?.connected) return;
    stomp = Stomp.over(new SockJS(`${API}/chat`));
    stomp.connect(
            { Authorization: BEARER ? "Bearer " + Token.get() : Token.get() },
            () => {
              ({ memberId: myId } = claims());
              stomp.subscribe(`/queue/unread.${myId}`, (msg) => {
                const dto = JSON.parse(msg.body);
                const id = mRoomId(dto);
                upBadge(id, mUnread(dto));
                upPrev(id, mLastMsg(dto));
                upTime(id, mLastSendTime(dto));
              });
            }
    );
  }

  /* ---------- 3) ë°© ì…ì¥ ---------- */
  async function enterRoom(id) {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("roomListSection").style.display = "none";
    document.getElementById("chatContainer").style.display = "flex";

    document.getElementById("roomId").value = id;
    upBadge(id, 0);

    // íŒ¨ë„ ì´ˆê¸°í™”
    formLoaded = false;
    document.getElementById("formInfoSection").style.display = "none";
    document.getElementById("toggleFormButton").textContent = "ì‹ ì²­ì„œ ë³´ê¸°";

    await connectRoomWS(id);
    await loadHistory(id);
  }

  function connectRoomWS(id) {
    return new Promise((res) => {
      const ready = () => {
        stomp.subscribe(`/sub/chat.room.${id}`, (m) => onPacket(JSON.parse(m.body), id));
        const box = document.getElementById("chatBox");
        box.addEventListener("scroll", () => {
          if (box.scrollTop + box.clientHeight >= box.scrollHeight - 5) sendAckVisible();
        });
        res();
      };
      if (stomp?.connected) ready();
      else {
        connectUnread();
        const w = setInterval(() => {
          if (stomp?.connected) {
            clearInterval(w);
            ready();
          }
        }, 100);
      }
    });
  }

  /* ---------- 4) íˆìŠ¤í† ë¦¬ ---------- */
  async function loadHistory(id) {
    const res = await fetch(`${API}/api/chat-room/${id}`, {
      headers: { Authorization: BEARER ? "Bearer " + Token.get() : Token.get() },
    });
    const list = await res.json();
    const box = document.getElementById("chatBox");
    box.innerHTML = "";
    list.forEach((p) => {
      const mine = p.senderId === myId;
      displayMsg(p, mine, mine ? p.isRead : true);
    });
    sendAckVisible();
  }

  /* ---------- 5) ì‹ ì²­ì„œ ì •ë³´ ---------- */
  async function loadApplicationForm(roomId) {
    try {
      const res = await fetch(`${API}/api/chat-room/${roomId}/applicationForm`, {
        headers: { Authorization: BEARER ? "Bearer " + Token.get() : Token.get() },
      });
      if (!res.ok) throw new Error(res.status);
      const info = await res.json();
      renderApplicationForm(info);
    } catch (e) {
      document.getElementById("formInfo").innerHTML =
              '<span style="color:red">ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</span>';
    }
  }

  function renderApplicationForm(info) {
    const box = document.getElementById("formInfo");
    box.innerHTML = `
          <div class="form-field"><b>ìƒíƒœ:</b> ${info.applicationFormStatus}</div>
          <div class="form-field"><b>ì˜ˆë§¤ êµ¬ë¶„:</b> ${info.ticketOpenType}</div>
          <div class="form-field"><b>ì˜ˆë§¤ì¼:</b> ${fmtDateTime(parseDate(info.openDate))}</div>
          ${info.applicationFormDetailResponseList
            .map(
                    (d, i) => `
            <div class="detail-box">
              <h5>ì„¸ë¶€ì‚¬í•­ #${i + 1}</h5>
              <div><b>ê³µì—° ì¼ì‹œ:</b> ${fmtDateTime(parseDate(d.performanceDate))}</div>
              <div><b>íšŒì°¨:</b> ${d.session}</div>
              <div><b>ìš”ì²­ ë§¤ìˆ˜:</b> ${d.requestCount}</div>
              ${d.hopeAreaResponseList?.length
                            ? `
                  <div><b>í¬ë§ êµ¬ì—­:</b></div>
                  <ul class="hope-list">
                    ${d.hopeAreaResponseList
                                    .map(
                                            (h) => `
                      <li>
                        (${h.priority}) ${h.location} â€“ â‚©${h.price.toLocaleString()}
                      </li>`
                                    )
                                    .join("")}
                  </ul>`
                            : ""}
              ${d.requirement ? `<div><i>${d.requirement}</i></div>` : ""}
            </div>`
            )
            .join("")}
        `;
  }

  /* ---------- 6) ì‹¤ì‹œê°„ íŒ¨í‚· ---------- */
  function onPacket(p, roomId) {
    if (p.type === "READ_ACK") {
      if (p.readerId !== myId) markReadAll(p.lastReadMessageId);
      return;
    }
    const mine = p.senderId === myId;
    displayMsg(p, mine, !mine);
    upPrev(roomId, p.message);
    upTime(roomId, p.sendDate);
  }

  /* ë©”ì‹œì§€ ë Œë”ë§ */
  function displayMsg(p, mine, read) {
    const box = document.getElementById("chatBox");
    const div = document.createElement("div");
    div.className = `msg ${mine ? "sender-me" : "sender-op"}`;
    div.dataset.msgId = p.messageId;

    // XSS ë³´í˜¸: textContent ì‚¬ìš©
    const spanNick = document.createElement("b");
    spanNick.textContent = p.senderNickname + ": ";
    const spanMsg = document.createElement("span");
    spanMsg.textContent = p.message;
    div.appendChild(spanNick);
    div.appendChild(spanMsg);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = fmtTime(parseDate(p.sendDate));
    if (mine) {
      if (!read) meta.innerHTML += '<span class="unread-dot"></span>';
      else meta.innerHTML += '<span class="read-check">âœ“</span>';
    }
    div.appendChild(meta);
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  /* ì½ìŒ ì²˜ë¦¬ */
  function markReadAll(upto) {
    const msgs = document.querySelectorAll(".msg.sender-me");
    for (const m of msgs) {
      m.querySelector(".unread-dot")?.remove();
      if (!m.querySelector(".read-check"))
        m.querySelector(".meta").innerHTML += '<span class="read-check">âœ“</span>';
      if (m.dataset.msgId === upto) break;
    }
  }
  function sendAckVisible() {
    const msgs = document.querySelectorAll("#chatBox .msg");
    if (!msgs.length) return;
    stomp.send(
            `/pub/chat.read.${document.getElementById("roomId").value}`,
            {},
            JSON.stringify({
              lastReadMessageId: msgs[msgs.length - 1].dataset.msgId,
              readDate: new Date().toISOString(),
            })
    );
  }

  /* ë°œì†¡ */
  function sendMsg() {
    const txt = document.getElementById("message").value.trim();
    if (!txt) return;
    stomp.send(
            `/pub/chat.message.${document.getElementById("roomId").value}`,
            {},
            JSON.stringify({ message: txt })
    );
    document.getElementById("message").value = "";
  }

  /* ---------- ì´ˆê¸°í™” ---------- */
  window.addEventListener("DOMContentLoaded", () => {
    document.getElementById("clientLoginButton").onclick = () => {
      Token.set(TOKENS.client);
      loadRooms();
      connectUnread();
    };
    document.getElementById("agentLoginButton").onclick = () => {
      Token.set(TOKENS.agent);
      loadRooms();
      connectUnread();
    };
    document.getElementById("sendButton").onclick = sendMsg;
    document.getElementById("logoutButton").onclick = () => {
      stomp?.disconnect();
      Token.clear();
      location.reload();
    };

    // ì‹ ì²­ì„œ í† ê¸€ ë²„íŠ¼
    document.getElementById("toggleFormButton").onclick = async () => {
      const panel = document.getElementById("formInfoSection");
      if (panel.style.display === "none" || panel.style.display === "") {
        if (!formLoaded) {
          await loadApplicationForm(document.getElementById("roomId").value);
          formLoaded = true;
        }
        panel.style.display = "block";
        document.getElementById("toggleFormButton").textContent = "ì‹ ì²­ì„œ ìˆ¨ê¸°ê¸°";
      } else {
        panel.style.display = "none";
        document.getElementById("toggleFormButton").textContent = "ì‹ ì²­ì„œ ë³´ê¸°";
      }
    };
  });
</script>
</body>
</html>
