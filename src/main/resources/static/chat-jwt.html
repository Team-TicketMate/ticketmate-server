<!-- ************************************************************
   TicketMate â€“ 1 : 1 Chat í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ (Infiniteâ€‘Scrollv4.0, 2025â€‘06â€‘27)
   --------------------------------------------------------------
   * Slice ê¸°ë°˜ í˜ì´ì§•(ê¸°ë³¸ 20ê°œ) & ë¬´í•œ ìŠ¤í¬ë¡¤ â†‘ êµ¬í˜„
   * first / last í”Œë˜ê·¸ë¡œ ì´ì „ í˜ì´ì§€ ì¡´ì¬ ì—¬ë¶€ íŒë‹¨
   * ìµœì‹  ë©”ì‹œì§€ê°€ í•­ìƒ ë§¨ ì•„ë˜(ì˜¤ë˜ëœ â†’ ìµœì‹ )ë¡œ ë Œë”ë§
************************************************************* -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>TicketMate â€“ ì±„íŒ…ë°©1â€‘1(v4.0)</title>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

  <style>
    :root {
      --bubble-op: #e8f0ff;
      --bubble-me: #d1ffe5;
    }
    body { font-family: Arial,sans-serif; margin:2rem; }

    /* ====== ë°© ëª©ë¡ ====== */
    #roomList { max-width:22rem; border:1px solid #ccc; padding:1rem; }
    .room-item { padding:0.6rem 0; border-bottom:1px solid #eee; cursor:pointer; }
    .room-item:hover { background:#f3f7ff; }
    .room-top { display:flex; justify-content:space-between; align-items:center; }
    .room-name { font-weight:bold; }
    .time { font-size:0.72rem; color:#888; margin-left:0.5rem; }
    .badge { background:#ff3b30; color:#fff; border-radius:12px; padding:0 6px; font-size:0.7rem; min-width:1.4rem; text-align:center; }
    .preview { font-size:0.78rem; color:#555; margin-top:0.15rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* ğŸ“Œ ì˜ˆë§¤ íƒ€ì… í‘œì‹œ */
    .ticket-type { font-size:0.7rem; padding:0.2rem 0.5rem; border-radius:8px; font-weight:bold; margin-left:0.5rem; }
    .ticket-type.pre-open { background:#4CAF50; color:white; }
    .ticket-type.general-open { background:#2196F3; color:white; }
    .room-info { display:flex; align-items:center; margin-top:0.15rem; }

    /* ====== ì±„íŒ… + ì‹ ì²­ì„œ ====== */
    #chatContainer { display:flex; gap:1rem; max-width:60rem; }
    #chatSection { display:flex; flex-direction:column; gap:0.5rem; flex:1; }
    #chatBox { height:300px; overflow-y:auto; display:flex; flex-direction:column; border:1px solid #ccc; padding:1rem; }
    .msg { margin:0.25rem 0; padding:0.5rem 0.75rem; border-radius:1rem; max-width:70%; white-space:pre-wrap; }
    .sender-op { background:var(--bubble-op); align-self:flex-start; border-top-left-radius:0; }
    .sender-me { background:var(--bubble-me); align-self:flex-end; border-top-right-radius:0; }
    .meta { font-size:0.7rem; color:#555; margin-top:0.2rem; display:flex; align-items:center; gap:0.25rem; }
    .unread-dot { width:7px; height:7px; background:#ff3b30; border-radius:50%; display:inline-block; }
    .read-check { font-size:0.8rem; color:#888; }

    /* ğŸ“Œ ì‹ ì²­ì„œ íŒ¨ë„ */
    #formInfoSection { width:20rem; border:1px solid #ccc; padding:1rem; overflow-y:auto; display:none; }
    #formInfoSection h4 { margin:0.2rem 0 0.6rem; font-size:1rem; }
    .form-field { margin:0.25rem 0; font-size:0.85rem; }
    .detail-box { margin:0.5rem 0; padding:0.5rem; border:1px solid #eee; border-radius:0.5rem; }
    .detail-box h5 { margin:0.1rem 0 0.3rem; font-size:0.8rem; font-weight:bold; }
    .hope-list { margin:0.2rem 0 0 0.8rem; font-size:0.78rem; list-style:square; }
  </style>
</head>
<body>
<div id="loginSection">
  <button id="clientLoginButton">ì˜ë¢°ì¸ ë¡œê·¸ì¸</button>
  <button id="agentLoginButton">ëŒ€ë¦¬ì¸ ë¡œê·¸ì¸</button>
</div>

<div id="roomListSection" style="display:none">
  <h3>ì±„íŒ…ë°© ëª©ë¡</h3>
  <div id="roomList"></div>
</div>

<!-- ğŸ“Œ ì±„íŒ…+ì‹ ì²­ì„œ ì»¨í…Œì´ë„ˆ -->
<div id="chatContainer" style="display:none">
  <!-- ===== ì±„íŒ… ì˜ì—­ ===== -->
  <div id="chatSection">
    <input id="roomId" readonly />
    <div style="display:flex; gap:0.5rem">
      <input id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦" />
      <button id="sendButton">ì „ì†¡</button>
      <button id="toggleFormButton">ì‹ ì²­ì„œ ë³´ê¸°</button>
      <button id="logoutButton">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div id="chatBox"></div>
  </div>

  <!-- ğŸ“Œ ì‹ ì²­ì„œ ì •ë³´ íŒ¨ë„ -->
  <div id="formInfoSection">
    <h4>ì‹ ì²­ì„œ ì •ë³´</h4>
    <div id="formInfo">â€“</div>
  </div>
</div>

<script>
  /* ===============================================
   * CONFIG & CONSTANTS
   =============================================== */

  const API = "https://api.ticketmate.site";
  const BEARER = true;
  const TOKENS = {
    client: "eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiLssYTtjIXtgbTrnbzsnbTslrjtirhAbmF2ZXIuY29tOTU1IiwiY2F0ZWdvcnkiOiJhY2Nlc3MiLCJ1c2VybmFtZSI6IuyxhO2Mhe2BtOudvOydtOyWuO2KuEBuYXZlci5jb205NTUiLCJtZW1iZXJJZCI6IjgyZDI2ODE1LWExMzUtNGY5NC05NjczLTczZDZiZWIwOGM0MCIsInJvbGUiOiJST0xFX1RFU1QiLCJpc3MiOiJUSUNLRVRfTUFURSIsImlhdCI6MTc1MjczOTU1NSwiZXhwIjoxNzU1MzMxNTU1fQ.kvmJlNkqPpX00D79hIu1WeZlHyFYyql2lcOaqzlbl0fUQnLzaiCjvzAf_1jnVEr_",
    agent: "eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiLssYTtjIXsl5DsnbTsoITtirhAbmF2ZXIuY29tOTY1IiwiY2F0ZWdvcnkiOiJhY2Nlc3MiLCJ1c2VybmFtZSI6IuyxhO2MheyXkOydtOyghO2KuEBuYXZlci5jb205NjUiLCJtZW1iZXJJZCI6IjdhMWJkMzQyLWJlMWItNDA5NS1iMjA5LTUwYzMzZGY5MzM2YSIsInJvbGUiOiJST0xFX1RFU1QiLCJpc3MiOiJUSUNLRVRfTUFURSIsImlhdCI6MTc1MjczOTUzNCwiZXhwIjoxNzU1MzMxNTM0fQ.yVtDvhECH4NyBjNCPEd4krcBh0NQ2lRpjRubG0xVOENGsRxNmq5HsVqOylFyFH01",
  };

  /* ===============================================
   * GLOBAL STATE
   =============================================== */
  let stomp = null;
  let myId = "";
  let formLoaded = false;
  const PAGE_SIZE = 20;           // Slice ê¸°ë³¸ í¬ê¸°

  let currentRoomId = null;      // ì ‘ì† ì¤‘ì¸ ì±„íŒ…ë°© ID
  let currentPage = 0;           // 0ë¶€í„° ì‹œì‘ (DESC ì •ë ¬ ê¸°ì¤€ ìµœì‹  í˜ì´ì§€)
  let lastPageReached = false;   // slice.last === true ì‹œì 
  let loadingOlder = false;      // ì¤‘ë³µ ë¡œë”© ë°©ì§€

  /* ===============================================
   * UTILITY FUNCTIONS
   =============================================== */
  // í† í° ê´€ë¦¬
  const Token = {
    set: (t) => sessionStorage.setItem("at", t),
    get: () => sessionStorage.getItem("at"),
    clear: () => sessionStorage.removeItem("at"),
  };

  // JWT í† í°ì—ì„œ í´ë ˆì„ ì¶”ì¶œ
  const claims = () => {
    try {
      return JSON.parse(atob(Token.get().split(".")[1]));
    } catch {
      return {};
    }
  };

  // ë‚ ì§œ íŒŒì‹± ë° í¬ë§·íŒ…
  const parseDate = (s) => {
    if (!s || typeof s !== "string") return null;
    return new Date(s.includes("T") ? s : s.replace(" ", "T"));
  };

  const fmtTime = (d) =>
          d ? d.toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit" }) : "";

  const fmtDateTime = (d) =>
          d
                  ? d.toLocaleString("ko-KR", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                  })
                  : "";

  /* ===============================================
   * DTO ë§¤í•‘Â·UI í—¬í¼ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
   =============================================== */
  // ì±„íŒ…ë°© ID ë§¤í•‘ (roomId -> chatRoomId ìš°ì„ )
  const mRoomId = (o) => o.chatRoomId ?? o.roomId;

  // ë¯¸ì½ìŒ ë©”ì‹œì§€ ìˆ˜ ë§¤í•‘ (unReadMessageCount ìš°ì„ )
  const mUnread = (o) => o.unReadMessageCount ?? o.unread;

  // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ë§¤í•‘
  const mLastMsg = (o) => o.lastMessage ?? o.lastChatMessage;

  // ë§ˆì§€ë§‰ ì „ì†¡ ì‹œê°„ ë§¤í•‘
  const mLastSendTime = (o) => o.sentAt ?? o.lastChatSendTime ?? o.sendDate;

  // ì˜ˆë§¤ íƒ€ì… ë§¤í•‘
  const mTicketOpenType = (o) => o.ticketOpenType;

  /* ===============================================
   * UI HELPER FUNCTIONS
   =============================================== */

  // ì˜ˆë§¤ íƒ€ì… í•œê¸€ ë³€í™˜ ë° CSS í´ë˜ìŠ¤ ë°˜í™˜
  const getTicketTypeInfo = (ticketOpenType) => {
    switch (ticketOpenType) {
      case "PRE_OPEN":
        return { text: "ì„ ì˜ˆë§¤", className: "pre-open" };
      case "GENERAL_OPEN":
        return { text: "ì¼ë°˜ì˜ˆë§¤", className: "general-open" };
      default:
        return { text: "ë¯¸ì •", className: "unknown" };
    }
  };

  // ì±„íŒ…ë°© ì•„ì´í…œ DOM ìƒì„± ë˜ëŠ” ì¡°íšŒ
  function ensureItem(id, name, ticketOpenType) {
    let el = document.querySelector(`.room-item[data-room-id="${id}"]`);
    if (el) return el;

    const ticketTypeInfo = getTicketTypeInfo(ticketOpenType);

    el = document.createElement("div");
    el.className = "room-item";
    el.dataset.roomId = id;
    el.innerHTML = `
            <div class="room-top">
                <span class="room-name">${name}</span>
                <span class="time" data-room-id="${id}"></span>
                <span class="badge" data-room-id="${id}" style="visibility:hidden"></span>
            </div>
            <div class="room-info">
                <div class="preview" data-room-id="${id}"></div>
                <span class="ticket-type ${ticketTypeInfo.className}">${ticketTypeInfo.text}</span>
            </div>
        `;
    el.onclick = () => enterRoom(id);
    document.getElementById("roomList").appendChild(el);
    return el;
  }

  // ë¯¸ì½ìŒ ë°°ì§€ ì—…ë°ì´íŠ¸
  const upBadge = (id, n) => {
    const b = document.querySelector(`.badge[data-room-id="${id}"]`);
    if (b) {
      b.textContent = n || "";
      b.style.visibility = n ? "visible" : "hidden";
    }
  };

  // ë¯¸ë¦¬ë³´ê¸° í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  const upPrev = (id, t) => {
    const p = document.querySelector(`.preview[data-room-id="${id}"]`);
    if (p) p.textContent = t || "";
  };

  // ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
  const upTime = (id, s) => {
    const t = document.querySelector(`.time[data-room-id="${id}"]`);
    if (t) t.textContent = fmtTime(parseDate(s));
  };

  /* ===============================================
   * API í†µì‹  í•¨ìˆ˜ë“¤
   =============================================== */

  // ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadRooms({ pageNumber = 1, ticketOpenType = '', searchKeyword = '' } = {}) {
    const qs = new URLSearchParams({ pageNumber });
    if (ticketOpenType) qs.append('ticketOpenType', ticketOpenType);
    if (searchKeyword)  qs.append('searchKeyword',  searchKeyword);

    const res = await fetch(
            `${API}/api/chat-room?` + qs.toString(),
            { headers: { Authorization: BEARER ? 'Bearer ' + Token.get() : Token.get() } }
    );
    const { content: rooms = [] } = await res.json();

    // ë°© ëª©ë¡ ì´ˆê¸°í™” + ë Œë”ë§
    const listEl = document.getElementById('roomList');
    listEl.innerHTML = '';
    rooms.forEach(r => {
      const id   = mRoomId(r);
      const type = mTicketOpenType(r);

      ensureItem(id, r.chatRoomName, type);
      upBadge(id, mUnread(r));
      upPrev(id, mLastMsg(r));
      upTime(id, mLastSendTime(r));
    });

    document.getElementById('roomListSection').style.display = 'block';
  }

  /* ===============================================
   * WEBSOCKET ì—°ê²° ë° ê´€ë¦¬
   =============================================== */

  // ë¯¸ì½ìŒ ë©”ì‹œì§€ ì•Œë¦¼ìš© WebSocket ì—°ê²°
  function connectUnread() {
    if (stomp?.connected) return;

    stomp = Stomp.over(new SockJS(`${API}/chat`));
    stomp.connect(
            { Authorization: BEARER ? "Bearer " + Token.get() : Token.get() },
            () => {
              // ì‚¬ìš©ì ID ì¶”ì¶œ
              ({ memberId: myId } = claims());

              // ë¯¸ì½ìŒ ë©”ì‹œì§€ ì•Œë¦¼ êµ¬ë…
              stomp.subscribe(`/queue/unread.${myId}`, (msg) => {
                const dto = JSON.parse(msg.body);
                const id = mRoomId(dto);

                // UI ì—…ë°ì´íŠ¸ (ë³€ê²½ëœ í•„ë“œëª… ì‚¬ìš©)
                upBadge(id, mUnread(dto));
                upPrev(id, mLastMsg(dto));
                upTime(id, mLastSendTime(dto));
              });
            }
    );
  }

  // ì±„íŒ…ë°© ì…ì¥ ë° ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë…
  function connectRoomWS(id) {
    return new Promise((res) => {
      const ready = () => {
        // ğŸ”¥ ë³€ê²½ëœ êµ¬ë… ê²½ë¡œ: ì‚¬ìš©ìë³„ ê°œë³„ ë¼ìš°íŒ…
        stomp.subscribe(
                `/exchange/chat.exchange/chat.room.${id}.user.${myId}`,
                (m) => onPacket(JSON.parse(m.body), id)
        );

        // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ë¡œ ì½ìŒ í™•ì¸ ì „ì†¡
        const box = document.getElementById("chatBox");
        box.addEventListener("scroll", () => {
          if (box.scrollTop + box.clientHeight >= box.scrollHeight - 5) {
            sendAckVisible();
          }
        });
        res();
      };

      // WebSocket ì—°ê²° ìƒíƒœ í™•ì¸ í›„ êµ¬ë…
      if (stomp?.connected) {
        ready();
      } else {
        connectUnread();
        const w = setInterval(() => {
          if (stomp?.connected) {
            clearInterval(w);
            ready();
          }
        }, 100);
      }
    });
  }

  /* ===============================================
   * ì±„íŒ…ë°© ì…ì¥ ë° ë©”ì‹œì§€ ì²˜ë¦¬
   =============================================== */
  async function enterRoom(id) {
    // UI ì„¸íŒ…
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("roomListSection").style.display = "none";
    document.getElementById("chatContainer").style.display = "flex";

    document.getElementById("roomId").value = id;
    upBadge(id, 0);

    formLoaded = false;
    document.getElementById("formInfoSection").style.display = "none";
    document.getElementById("toggleFormButton").textContent = "ì‹ ì²­ì„œ ë³´ê¸°";

    currentRoomId = id;
    currentPage = 0;
    lastPageReached = false;

    await connectRoomWS(id);
    await loadSlice(id, currentPage, true);  // ìµœì‹  20ê°œ ë¡œë“œ
  }

  // Slice ë¡œë“œ (page: 0,1,2â€¦ / sort: DESC) â†’ í™”ë©´ì— ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ë Œë”ë§
  async function loadSlice(roomId, page, initialLoad = false) {
    if (loadingOlder) return;
    loadingOlder = true;

    const url = `${API}/api/chat-room/${roomId}` +
            `?pageNumber=${page + 1}&pageSize=${PAGE_SIZE}`; // 1â€‘base

    const res = await fetch(url, {
      headers: { Authorization: BEARER ? "Bearer " + Token.get() : Token.get() },
    });
    if (!res.ok) { loadingOlder = false; return; }

    const slice = await res.json();
    const list = slice.content || [];

    // ì„œë²„ëŠ” DESC ì •ë ¬(ìµœì‹ â†’ì˜¤ë˜ëœ)ìœ¼ë¡œ ë‚´ë ¤ì£¼ë¯€ë¡œ ì—­ìˆœìœ¼ë¡œ ë’¤ì§‘ì–´ ì˜¤ë˜ëœâ†’ìµœì‹  ì •ë ¬
    list.reverse();

    const box = document.getElementById("chatBox");

    if (initialLoad) box.innerHTML = ""; // ì²« ë¡œë“œì¼ ë•Œ ì´ˆê¸°í™”

    // ê¸°ì¡´ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ (ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°ìš©)
    const prevHeight = box.scrollHeight;

    // older ë©”ì‹œì§€ëŠ” prepend, ìµœì‹  20ê°œëŠ” append
    list.forEach((p) => {
      const isMine = p.mine;
      const isRead = p.read ?? p.isRead ?? (initialLoad ? true : !p.mine);
      displayMsg(p, isMine, isRead, !initialLoad /*prepend?*/);
    });

    if (initialLoad) {
      box.scrollTop = box.scrollHeight; // ìµœì‹ ìœ¼ë¡œ ì´ë™
    } else {
      // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ìœ ì§€ (prependë¡œ ì¸í•´ ë‚´ë ¤ê°„ ë§Œí¼ ë³´ì •)
      box.scrollTop = box.scrollHeight - prevHeight;
    }

    // ë‹¤ìŒ í˜ì´ì§€ ê³„ì‚°
    if (!slice.last) {
      currentPage += 1;
    } else {
      lastPageReached = true;
    }

    loadingOlder = false;
  }

  /* ===============================================
   * ì‹ ì²­ì„œ ì •ë³´ ê´€ë¦¬
   =============================================== */

  // ì‹ ì²­ì„œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadApplicationForm(roomId) {
    try {
      const res = await fetch(`${API}/api/chat-room/${roomId}/application-form`, {
        headers: { Authorization: BEARER ? "Bearer " + Token.get() : Token.get() },
      });
      if (!res.ok) throw new Error(res.status);
      const info = await res.json();
      renderApplicationForm(info);
    } catch (e) {
      document.getElementById("formInfo").innerHTML =
              '<span style="color:red">ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</span>';
    }
  }

  // ì‹ ì²­ì„œ ì •ë³´ ë Œë”ë§
  function renderApplicationForm(info) {
    const box = document.getElementById("formInfo");
    box.innerHTML = `
            <div class="form-field"><b>ìƒíƒœ:</b> ${info.applicationFormStatus}</div>
            <div class="form-field"><b>ì˜ˆë§¤ êµ¬ë¶„:</b> ${info.ticketOpenType}</div>
            <div class="form-field"><b>ì˜ˆë§¤ì¼:</b> ${fmtDateTime(parseDate(info.openDate))}</div>
            ${info.applicationFormDetailResponseList
            .map(
                    (d, i) => `
                <div class="detail-box">
                    <h5>ì„¸ë¶€ì‚¬í•­ #${i + 1}</h5>
                    <div><b>ê³µì—° ì¼ì‹œ:</b> ${fmtDateTime(parseDate(d.performanceDate))}</div>
                    <div><b>íšŒì°¨:</b> ${d.session}</div>
                    <div><b>ìš”ì²­ ë§¤ìˆ˜:</b> ${d.requestCount}</div>
                    ${d.hopeAreaResponseList?.length
                            ? `
                        <div><b>í¬ë§ êµ¬ì—­:</b></div>
                        <ul class="hope-list">
                            ${d.hopeAreaResponseList
                                    .map(
                                            (h) => `
                                <li>
                                    (${h.priority}) ${h.location} â€“ â‚©${h.price.toLocaleString()}
                                </li>`
                                    )
                                    .join("")}
                        </ul>`
                            : ""}
                    ${d.requirement ? `<div><i>${d.requirement}</i></div>` : ""}
                </div>`
            )
            .join("")}
        `;
  }

  /* ===============================================
   * ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì²˜ë¦¬ ë° ë Œë”ë§ í•¨ìˆ˜
   =============================================== */
  // displayMsg ìˆ˜ì • â†’ prepend ì§€ì›
  function displayMsg(p, isMine, isRead, prepend = false) {
    const box = document.getElementById("chatBox");
    const div = document.createElement("div");

    div.className = `msg ${isMine ? "sender-me" : "sender-op"}`;
    div.dataset.msgId = p.messageId;

    const spanNick = document.createElement("b");
    spanNick.textContent = p.senderNickname + ": ";
    const spanMsg = document.createElement("span");
    spanMsg.textContent = p.message;
    div.appendChild(spanNick);
    div.appendChild(spanMsg);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = fmtTime(parseDate(p.sendDate));

    if (isMine) {
      meta.innerHTML += isRead
              ? '<span class="read-check">âœ“</span>'
              : '<span class="unread-dot"></span>';
    }
    div.appendChild(meta);

    if (prepend) {
      box.prepend(div);          // ê³¼ê±° ë©”ì‹œì§€
    } else {
      box.appendChild(div);      // ìƒˆ ë©”ì‹œì§€
      box.scrollTop = box.scrollHeight;  // â˜… í•­ìƒ ë§¨ ì•„ë˜ë¡œ ì´ë™
    }
  }

  // onPacket / markReadAll / sendAckVisible / sendMsg (ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ)

  /* ===============================================
* ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì²˜ë¦¬
=============================================== */

  // ì‹¤ì‹œê°„ íŒ¨í‚· ì²˜ë¦¬
  function onPacket(p, roomId) {
    // ì½ìŒ í™•ì¸ íŒ¨í‚· ì²˜ë¦¬
    if (p.type === "READ_ACK") {
      if (p.readerId !== myId) {
        markReadAll(p.lastReadMessageId);
      }
      return;
    }

    // ğŸ”¥ ì„œë²„ì˜ mine í”Œë˜ê·¸ ì‚¬ìš©
    displayMsg(p, p.mine, !p.mine); // ìƒëŒ€ë°© ë©”ì‹œì§€ëŠ” ì½ìŒ ì²˜ë¦¬

    // ë°© ëª©ë¡ UI ì—…ë°ì´íŠ¸
    upPrev(roomId, p.message);
    upTime(roomId, p.sendDate);
  }

  // ì½ìŒ ì²˜ë¦¬ UI ì—…ë°ì´íŠ¸
  function markReadAll(upto) {
    const msgs = document.querySelectorAll(".msg.sender-me");
    for (const m of msgs) {
      // ë¯¸ì½ìŒ ì  ì œê±°
      m.querySelector(".unread-dot")?.remove();

      // ì½ìŒ ì²´í¬ ì¶”ê°€
      if (!m.querySelector(".read-check")) {
        m.querySelector(".meta").innerHTML += '<span class="read-check">âœ“</span>';
      }

      // í•´ë‹¹ ë©”ì‹œì§€ê¹Œì§€ë§Œ ì²˜ë¦¬
      if (m.dataset.msgId === upto) break;
    }
  }

  // ì½ìŒ í™•ì¸ ì „ì†¡
  function sendAckVisible() {
    const msgs = document.querySelectorAll("#chatBox .msg");
    if (!msgs.length) return;

    stomp.send(
            `/pub/chat.read.${document.getElementById("roomId").value}`,
            {},
            JSON.stringify({
              lastReadMessageId: msgs[msgs.length - 1].dataset.msgId,
              readDate: dayjs().format("YYYY-MM-DDTHH:mm:ss"), // â† ë” ê°„ë‹¨!
            })
    );
  }

  // ë©”ì‹œì§€ ì „ì†¡
  function sendMsg() {
    const txt = document.getElementById("message").value.trim();
    if (!txt) return;

    stomp.send(
            `/pub/chat.message.${document.getElementById("roomId").value}`,
            {},
            JSON.stringify({ message: txt })
    );
    document.getElementById("message").value = "";
  }


  /* ===============================================
   * ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ â€“ ë¬´í•œ ìŠ¤í¬ë¡¤ & ì½ìŒ í™•ì¸
   =============================================== */
  function attachScrollEvents() {
    const box = document.getElementById("chatBox");
    box.addEventListener("scroll", async () => {
      // ë§¨ ìœ„ ë„ë‹¬ â†’ ì´ì „ Slice ë¡œë“œ
      if (box.scrollTop === 0 && !lastPageReached && !loadingOlder) {
        await loadSlice(currentRoomId, currentPage);
      }

      // ë§¨ ì•„ë˜ 5px ì´ë‚´ â†’ ì½ìŒ í™•ì¸ ì „ì†¡
      if (box.scrollTop + box.clientHeight >= box.scrollHeight - 5) {
        sendAckVisible();
      }
    });
  }

  /* ===============================================
   * ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
   =============================================== */
  window.addEventListener("DOMContentLoaded", () => {
    // ë¡œê·¸ì¸ ë²„íŠ¼
    document.getElementById('clientLoginButton').onclick = () => {
      Token.set(TOKENS.client);
      loadRooms();          // pageNumber ê¸°ë³¸ 1
      connectUnread();
    };

    document.getElementById('agentLoginButton').onclick = () => {
      Token.set(TOKENS.agent);
      loadRooms();
      connectUnread();
    };

    // ì±„íŒ… ê´€ë ¨ ë²„íŠ¼
    document.getElementById("sendButton").onclick = sendMsg;
    document.getElementById("logoutButton").onclick = () => {
      stomp?.disconnect(); Token.clear(); location.reload(); };

    document.getElementById("toggleFormButton").onclick = async () => {
      const panel = document.getElementById("formInfoSection");
      const btn = document.getElementById("toggleFormButton");
      if (panel.style.display === "none" || panel.style.display === "") {
        if (!formLoaded) { await loadApplicationForm(currentRoomId); formLoaded = true; }
        panel.style.display = "block"; btn.textContent = "ì‹ ì²­ì„œ ìˆ¨ê¸°ê¸°";
      } else { panel.style.display = "none"; btn.textContent = "ì‹ ì²­ì„œ ë³´ê¸°"; }
    };

    document.getElementById("message").addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMsg();
    });

    // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë°”ì¸ë“œ
    attachScrollEvents();
  });
</script>
</body>
</html>